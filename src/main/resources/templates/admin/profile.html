<!DOCTYPE html>
<html lang="en">
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/base :: layout(~{::title}, ~{::content})}">

<head>
  <title>Profile</title>
</head>

<body>
  <div th:fragment="content">
    <div class="content">
      <div class="container-fluid">
        <h4 class="page-title">Profile</h4>
        <div class="row">
          <div class="container">
            <div class="row flex-lg-nowrap">
              <div class="col">
                <div class="row">
                  <div class="col mb-3">
                    <div class="card">
                      <div class="card-body">
                        <div class="e-profile">
                          <form id="profile-update-form" method="post" class="form">
                            <div class="row">
                              <div class="col-12 col-sm-auto mb-3">
                                <div class="mx-auto" style="width: 140px;">
                                  <div class="d-flex justify-content-center align-items-center rounded"
                                    style="height: 160px; background-color: rgb(233, 236, 239);">
                                    <img id="selectedAvatar"
                                      style="width: 160px;     height: 160px;    object-fit: cover;">

                                  </div>
                                </div>

                              </div>
                              <div class="col d-flex flex-column flex-sm-row justify-content-between mb-3">
                                <div class="text-center text-sm-left mb-2 mb-sm-0">
                                  <h4 class="pt-sm-2 pb-1 mb-0 text-nowrap">
                                    <span></span> <span></span>
                                  </h4>
                                  <p class="mb-0"><span></span>
                                  </p>
                                  <!-- <div class="text-muted"><small>Last seen 2 hours
                                      ago</small></div> -->
                                  <div class="mt-2">

                                    <button class="btn btn-primary" type="button">
                                      <label class="form-label mb-auto" for="customFile2">
                                        <span style="color: white;"><i class="fa fa-fw fa-camera"></i>Change
                                          Photo</span>
                                      </label>
                                      <input type="file" class="form-control d-none" id="customFile2"
                                        onchange="displaySelectedImage(event, 'selectedAvatar')" />
                                    </button>
                                    <button id="remove-image" class="btn btn-primary mx-1" type="button">
                                      <span>Remove</span>
                                    </button>
                                  </div>
                                  <p id="fileError" style="font-size: small;" class="text-danger"></p>
                                </div>
                                <div class="text-center text-sm-right">
                                  <span class="badge badge-secondary">administrator</span>
                                  <div class="text-muted"><small>Joined 09 Dec
                                      2017</small></div>
                                </div>
                              </div>
                            </div>
                            <ul class="nav nav-tabs">
                              <li class="nav-item">
                                <button href="" class="active nav-link">Account</button>
                              </li>
                            </ul>
                            <div class="tab-content pt-3">
                              <div class="tab-pane active">

                                <div class="row">
                                  <div class="col">
                                    <div class="row">
                                      <div class="col">
                                        <div class="form-group">
                                          <label>First Name</label>
                                          <input class="form-control form-control-sm" name="firstname" type="text"
                                            id="firstname" placeholder="Enter your firstname..">
                                          <p id="firstnameError" class="text-danger" style="font-size: smaller;"></p>
                                        </div>
                                      </div>
                                      <div class="col">
                                        <div class="form-group">
                                          <label>Last Name</label>
                                          <input class="form-control form-control-sm" name="lastname" type="text"
                                            id="lastname" placeholder="Enter your lastname..">
                                          <p id="lastnameError" class="text-danger" style="font-size: smaller;"></p>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col">
                                        <div class="form-group">
                                          <label>Email</label>
                                          <input class="form-control form-control-sm" name="email" type="email"
                                            id="email" placeholder="Enter your email..">
                                          <p id="emailError" style="font-size: smaller;" class="text-danger small"></p>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col">
                                        <div class="form-group">
                                          <label>Phone Number</label>
                                          <input class="form-control form-control-sm" name="phone" type="number"
                                            id="phone" placeholder="Enter your phone number..">
                                          <p id="phoneError" class="text-danger" style="font-size: small;"></p>
                                        </div>
                                      </div>
                                    </div>

                                  </div>

                                </div>
                                <div class="row">
                                  <div class="col d-flex justify-content-end">
                                    <button class="btn btn-primary" type="submit" style="margin-right: 12px;">
                                      <span id="btn-loader" style="display: none;"><i
                                          class="fa fa-spinner fa-pulse"></i></span>
                                      Save Changes
                                    </button>
                                  </div>
                                </div>


                              </div>
                            </div>
                        </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Modal dialog container change password start-->
                  <div class="modal fade" id="passwordChangeModel" tabindex="-1" role="dialog"
                    aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                      <div class="modal-content">
                        <form id="password-change-form" role="form">
                          <div class="modal-header">
                            <h5 class="modal-title text-center" id="exampleModalLongTitle">
                              Password change
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="small mb-1" for="email">Current
                                Password<span class="text-danger">*</span></label>

                              <div class="input-group" id="show_hide_password">
                                <input style="border-radius: 4px;" class="form-control small" type="password"
                                  placeholder="Enter your current password.." id="currentPassword"
                                  name="currentPassword">
                                <div class="input-group-addon">
                                  <a href=""><i class="fa fa-eye-slash" aria-hidden="true"></i></a>
                                </div>
                              </div>

                              <p id="currentPasswordError" style="font-size: small;" class="text-danger small error">
                              </p>
                            </div>
                            <div class="mb-3">
                              <label class="small mb-1" for="email">New
                                Password<span class="text-danger">*</span></label>
                              <input class="form-control small" type="password" placeholder="Enter new password.."
                                id="newPassword" name="newPassword">
                              <p id="newPasswordError" style="font-size: small;" class="text-danger small error">
                              </p>
                            </div>
                            <div class="mb-3">
                              <label class="small mb-1" for="phone">Confirm
                                Password<span class="text-danger">*</span></label>
                              <input class="form-control small" type="password" placeholder="Enter confirm password.."
                                name="confirmPassword" id="confirmPassword">
                              <p id="confirmPasswordError" style="font-size: small;" class="text-danger small error">
                              </p>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">
                              <span id="btn-loader" style="display: none;"><i class="fa fa-spinner fa-pulse"></i></span>
                              Save changes
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <!-- Modal dialog container change password end-->

                  <div class="col-12 col-md-3 mb-3">
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="px-xl-3">
                          <button data-toggle="modal" data-target="#passwordChangeModel"
                            class="btn btn-block btn-secondary">
                            <i class="fa fa-sign-out"></i>
                            <span>Change Password</span>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="px-xl-3">
                          <a href="/logout">
                            <button class="btn btn-block btn-secondary">
                              <i class="fa fa-sign-out"></i>
                              <span>Logout</span>
                            </button>
                          </a>
                        </div>
                      </div>
                    </div>
                    <div class="card">
                      <div class="card-body">
                        <h6 class="card-title font-weight-bold">Support</h6>
                        <p class="card-text">Get fast, free help from our friendly
                          assistants.</p>
                        <button type="button" class="btn btn-primary">Contact Us</button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>


        </div>
      </div>
    </div>
    <script>
      function displaySelectedImage(event, elementId) {
        const selectedImage = document.getElementById(elementId);
        const fileInput = event.target;

        var image = document.getElementById('customFile2').files[0];
        var filename = image.name;
        var fileExtension = filename.split('.').pop().toLowerCase();
        if (fileExtension !== 'jpg' && fileExtension !== 'jpeg' && fileExtension !== 'png') {
          $('#fileError').text('*Only PNG, JPEG, or JPG files are allowed.');
          return;
        }
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();

          reader.onload = function (e) {
            selectedImage.src = e.target.result;
          };

          reader.readAsDataURL(fileInput.files[0]);
        }
      }

      $(document).ready(function () {
        $('#toast-close').click(function () {
          $('#toast').hide(500);
        })

        // Hide the toast message after 3 seconds (3000 milliseconds)
        function hideToast() {
          setTimeout(function () {
            $('#toast').fadeOut();
          }, 3000);
        };


        // get current user details
        function fetchCurrentUser() {
          $('#loader').show();
          $('.content').hide();
          $.ajax({
            type: 'GET',
            url: '/getCurrentUser',
            contentType: 'application/json',
            success: function (response) {
              var user = response.data;
              $('#firstname').val(user.firstname);
              $('#lastname').val(user.lastname);
              $('#email').val(user.email);
              $('#phone').val(user.phone);
              if (user.imageUrl === null) {
                $('#selectedAvatar').prop('src', '/img/user-default.png');
              } else {
                $('#selectedAvatar').prop('src', user.imageUrl);
                // $('#customFile2').files[0].val(user.imageName);
              }
              $('#date').text(user.createdAt);
            },
            error: function (xhr, status, error) {
              var errors = xhr.responseJSON;
              $('.toast').removeClass('bg-success');
              $('.toast').addClass('bg-danger');
              $('.toast').toast('show');
              $('#msg').text(errors.message);
            },
            complete: function () {
              $('.content').show();
              $('#loader').hide();
              $('#content').css('opacity', 1.0);
            }
          });
        }
        fetchCurrentUser();

        $('#firstname').focus(function () {
          $('input').css('border-color', '');
          $('#firstnameError').text('');
        })
        $('#lastname').focus(function () {
          $('input').css('border-color', '');
          $('#lastnameError').text('');
        })
        $('#email').focus(function () {
          $('input').css('border-color', '');
          $('#emailError').text('');
        })
        $('#phone').focus(function () {
          $('input').css('border-color', '');
          $('#phoneError').text('');
        })

        $('#profile-update-form').submit(function (event) {
          event.preventDefault();

          var image = document.getElementById('customFile2').files[0];

          var firstname = $('#firstname').val().trim();
          var lastname = $('#lastname').val().trim();
          var email = $('#email').val().trim();
          var phone = $('#phone').val().trim();

          var formData = new FormData();
          formData.append('firstname', firstname);
          formData.append('lastname', lastname);
          formData.append('email', email);
          formData.append('phone', phone);
          formData.append('image', image);

          if (firstname === '') {
            $('#firstname').css('border-color', 'red');
            $('#firstnameError').text('*Please enter your first name.');
          } else if (email === '') {
            $('#email').css('border-color', 'red');
            $('#emailError').text('*Please enter your email.');
          } else if (phone === '') {
            $('#phone').css('border-color', 'red');
            $('#phoneError').text('*Please confirm your phone number.');
          } else {
            $('#btn-loader').show();
            $.ajax({
              type: 'POST',
              url: '/profile/update',
              contentType: false,
              processData: false,
              data: formData,
              success: function (response) {
                $('.toast').removeClass("bg-danger border-danger");
                $('#msg').text(response.message);
                $('.toast').addClass("bg-success border-success");
                $('#toast').show();
              },
              error: function (xhr, status, error) {
                var errors = xhr.responseJSON;
                $('.toast').removeClass("bg-success border-success");
                $('#msg').text(errors.message);
                $('.toast').addClass("bg-danger border-danger");
                $('#toast').show();
              },
              complete: function () {
                $('#btn-loader').hide();
                fetchCurrentUser();
              }
            });
          }
        });

        // clear modal field error if focus on field
        $('#currentPassword').focus(function () {
          $('input').css('border-color', '');
          $('#currentPasswordError').text('');
        });
        $('#newPassword').focus(function () {
          $('input').css('border-color', '');
          $('#newPasswordError').text('');
        });
        $('#confirmPassword').focus(function () {
          $('input').css('border-color', '');
          $('#confirmPasswordError').text('');
        });

        // Remove validation errors when the modal dialog is closed
        $('#passwordChangeModel').on('hidden.bs.modal', function () {
          $('input').css('border-color', '');
          $('.error').text('');
          $('#password-change-form')[0].reset();
        });
        // event hadler for password change
        $(document).on('submit', '#password-change-form', function (event) {
          event.preventDefault();
          var currentPassword = $('#currentPassword').val().trim();
          var newPassword = $('#newPassword').val().trim();
          var confirmPassword = $('#confirmPassword').val().trim();

          var loader = $(this).closest("#passwordChangeModel").find("#btn-loader");
          if (currentPassword === '') {
            $('#currentPassword').css('border-color', 'red');
            $('#currentPasswordError').text('*Please enter your current password.');
          } else if (newPassword === '') {
            $('#newPassword').css('border-color', 'red');
            $('#newPasswordError').text('*Please enter your new password.');
          } else if (confirmPassword === '') {
            $('#confirmPassword').css('border-color', 'red');
            $('#confirmPasswordError').text('*Please confirm your new password.');
          } else if (!(newPassword === confirmPassword)) {
            $('#confirmPassword').css('border-color', 'red');
            $('#confirmPasswordError').text('*Password do not match.');
          } else {
            loader.show();
            $.ajax({
              type: 'POST',
              url: '/profile/changePassword ',
              data: {
                oldPassword: currentPassword,
                newPassword: newPassword
              },
              success: function (response) {
                $('.toast').removeClass("bg-danger border-danger");
                $('#msg').text(response.message);
                $('.toast').addClass("bg-success border-success");
                $('#toast').show();
                $('#passwordChangeModel').modal('hide');
                $('#password-change-form')[0].reset();
              },
              error: function (xhr, status, error) {
                var errors = xhr.responseJSON;
                if (xhr.status === 400) {
                  $('#currentPasswordError').text(errors.message)
                } else {
                  $('.toast').removeClass("bg-success border-success");
                  $('#msg').text(errors.message);
                  $('.toast').addClass("bg-danger border-danger");
                  $('#toast').show();
                }
              },
              complete: function () {
                hideToast();
                loader.hide();
              }
            });
          }
        });
      })








      $("#show_hide_password a").on('click', function (event) {
        event.preventDefault();
        if ($('#show_hide_password input').attr("type") == "text") {
          $('#show_hide_password input').attr('type', 'password');
          $('#show_hide_password i').addClass("fa-eye-slash");
          $('#show_hide_password i').removeClass("fa-eye");
        } else if ($('#show_hide_password input').attr("type") == "password") {
          $('#show_hide_password input').attr('type', 'text');
          $('#show_hide_password i').removeClass("fa-eye-slash");
          $('#show_hide_password i').addClass("fa-eye");
        }
      });
    </script>

  </div>
</body>

</html>